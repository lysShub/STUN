# STUN

UDP穿隧；

实现了(rfc3489)[https://tools.ietf.org/html/rfc3489]的功能，但并没有遵循其协议。



### NAT判断

NAT类型判断是穿隧的第一步。

#### NAT类型

| name                              | directions                                                   |      |
| --------------------------------- | ------------------------------------------------------------ | ---- |
| 完全锥形(Full Cone)               | 映射建立后，NAT会接收并转发所有数据包，转发到映射对应的内网机器上 |      |
| IP限制锥形(IPRestricted Cone)     | 映射建立后，NAT只会接收并转发来自指定IP的数据包，这个指定IP在映射创建时确定 |      |
| 端口限制锥形(PortRestricted Cone) | 映射建立后，NAT只会接收并转发来自指定IP且指定端口的数据包    |      |
| 对称形(Symmetric NAT)             | 对”来“的数据包具有端口限制锥形的规则同时；如果”去“的数据包的四元组发生改变，还将会创建新的映射 |      |

说明：

- 映射的建立只能是由内网机器请求公网IP。
- IP限制锥形大多时称为限制锥形(Restricted Cone)，我这样写更直观。



#### NAT类型判断

我们要想完成穿隧，必须先要判断NAPT类型。

我们可以不将完全锥形和IP限制锥形加以区分，因为这两者在穿隧时是相同的。这样带来的好处是我们只需要一台服务器即可实现NAT的判断。

| 序号                       | 发送者       | 接收者       | 数据    | 说明                                                         |
| -------------------------- | ------------ | ------------ | ------- | ------------------------------------------------------------ |
| 1                          | client:19987 | sever:19987  | Juuid:1 | 表示开始一次NAT判断，sever保存Juuid、对方网关端口            |
| 2                          | sever:19987  | client:19987 | Juuid:2 | sever回复client，client接下来将执行3                         |
| 3                          | client:19988 | sever:19987  | Juuid:3 | sever比较两次的网关端口是否相等；相等需要进一步判断(能否收到4)；不相等则有对称形NAT和公网IP两种情况，如果两次的网关端口为19987和19988则为公网IP(9)，否则为对称NAT(d)。 |
| 4                          | sever:19988  | client:19987 | Juuid:4 | sever使用19988端口进行回复，client不能能收到则表示为端口限制形NAT(c)，否则为完全或IP限制锥形NAT(6) |
| 5                          | sever:19987  | client:19987 | Juuid:5 | 表示服务器执行了4                                            |
| <font color='red'>6</font> | client:19987 | sever:19987  | Juuid:6 | 收到5且收到4，为完全或IP限制锥形NAT，如须进一步区分、执行7,8 |
| 7                          | sever2:19987 | client:19987 | Juuid:7 | 用于区分完全和IP限制锥形NAT(sever2的IP与sever不同)           |
| 8                          | sever:19987  | client:19987 | Juuid:8 | 表示服务器执行了7(由于7可选，所以没有收到8表示不用区分，返回6即可) |
| <font color='red'>9</font> | sever:19987  | client:19987 | Juuid:9 | 公网IP                                                       |
| <font color='red'>a</font> | client:19987 | sever:19987  | Juuid:a | client收到8且收到7，完全锥形nat                              |
| <font color='red'>b</font> | client:19987 | sever:19987  | Juuid:b | client收到8且没有收到7，IP限制形nat                          |
| <font color='red'>c</font> | client:19987 | sever:19987  | Juuid:c | client收到5但没有收到4，端口限制nat                          |
| <font color='red'>d</font> | sever:19987  | client:19987 | Juuid:d | 对称形nat                                                    |
| <font color='red'>e</font> | client:19987 | sever:19987  | Juuid:e | 执行1后没有收到2，可能服务器关闭（无意义）                   |
| <font color='red'>f</font> | client:19987 | sever:19987  | Juuid:e | 异常情况，比如收到7但没有收到8，收到4但没有收到5等情况       |

说明：红色即是返回值；Juuid 为判断id，由‘J'加位随128机组成。对完全和IP限制锥形NAT的判断是可选的，因为在穿透是没有区别、且区分需要两个网卡(公网IP)；不区分返回6，区分返回a或b。





### NAT穿透

实现NAT穿透

#### 穿隧情况分类

对严苛的NAT条件完成穿隧的操作，也适用于更加宽松的NAT条件；这样可以简化条件

| sender       | receiver     | ok?  | 过程                                                         |
| ------------ | ------------ | ---- | ------------------------------------------------------------ |
| 完全锥形     | 完全锥形     | √    | 同IP限制锥形-完全锥形                                        |
| 完全锥形     | IP限制锥形   | √    | 同IP限制锥形-完全锥形                                        |
| 完全锥形     | 端口限制锥形 | √    | 同IP限制锥形-完全锥形                                        |
| 完全锥形     | 对称形       | ╳✓   | 同IP限制锥形-完全锥形                                        |
| IP限制锥形   | 完全锥形     | √    | 同IP限制锥形-完全锥形                                        |
| IP限制锥形   | IP限制锥形   | √    | 同IP限制锥形-完全锥形                                        |
| IP限制锥形   | 端口限制锥形 | √    | 同IP限制锥形-完全锥形                                        |
| IP限制锥形   | 对称形       | ╳✓   | S、R使用19986端口请求SV，SV获取到S、R的网关地址，SV控制S向R的网关IP的任意端口发送任意数据包，此时S的网关将接收来自R网关的IP的任意端口的数据包；SV又控制R向S的网关的端口发送数据包；S获取到了数据包，同时S也获取到R的网关的地址，S回复R，R收到这个数据包，即完成隧道建立。（此操作要只求S的限制至少比IP限制锥形低）（当R请求SV和S的网关IP不同是则无法完成隧道建立） |
| 端口限制锥形 | 完全锥形     | √    | 同对称形-IP限制锥形                                          |
| 端口限制锥形 | IP限制锥形   | √    | 同对称形-IP限制锥形                                          |
| 端口限制锥形 | 端口限制锥形 | ╳    |                                                              |
| 端口限制锥形 | 对称形       | ╳    |                                                              |
| 对称形       | 完全锥形     | ✓    | 同对称形-IP限制锥形                                          |
| 对称形       | IP限制锥形   | ╳✓   | 与IP限制锥形-端口限制锥形类似。S、R请求SV、SV获取到S、R的网关地址，SV控制R向S的网关IP的任意端口发送任意数据包，此时R的网关将接收来自S网关的任意端口的数据包；SV又控制S网关的网关端口发送数据包，；R获取到数据包、也获取到S的地址，R回复S，S收到这个数据包，即完成穿隧。（此操作要只求R的限制至少比IP限制锥形低） |
| 对称形       | 端口限制锥形 | ╳    |                                                              |
| 对称形       | 对称形       | ╳    |                                                              |



#### 穿隧步骤

尝试穿隧单端口

**发送端低于IP限制锥形**(穿隧端口为19986) , 穿隧id：TunnelID，传输id：transpID

| 序号 | next | 发送端    | 接收端       | data                                  | 说明                                                         |
| ---- | ---- | --------- | ------------ | ------------------------------------- | ------------------------------------------------------------ |
| 1    | 2    | S/R:19986 | SV:19986     | 1:transpID                            | S、R请求SV、用于获取，TunnelID，SV记录双方网关地址           |
| 2    | 4    | SV:19986  | S:19986      | 2:transpID:TunnelID:ri:rp:snapt:rnapt | SV返回穿隧id和对方网关地址，S需要判断是否能穿隧，再判断是否发包(步骤4) |
| 3    | 5    | SV:19986  | R:19986      | 3:transpID:TunnelID:si:sp:snapt:rnapt | SV返回穿隧id和对方网关地址，R需要判断是否发包(步骤4)         |
| 4    | 6    | S:19986   | R:any        | 4:transpID:TunnelID                   | S向R的网关地址的任意端口发包                                 |
| 5    | 7    | R:19986   | S:any        | 5:transpID:TunnelID                   | R向S的网关地址的任意端口发包                                 |
| 6    | 8    | S:19986   | SV:19986     | 6:transpID:TunnelID                   | S请求SV，要求R向S发包(即步骤8)                               |
| 7    | 9    | R:19986   | SV:19986     | 7:transpID:TunnelID                   | R请求SV，要求S向R发包(即步骤9)                               |
| 8    | 10   | SV:19986  | R:19986      | 8:transpID:TunnelID                   | SV请求R                                                      |
| 9    | 11   | SV:19986  | S:19986      | 9:transpID:TunnelID                   | SV请求S                                                      |
| 10   |      | R:19986   | S:sp和S:sp+n | 10:transpID:TunnelID:sp               | R请求S，如果S没有收到包，无法穿隧                            |
| 11   |      | S:19986   | R:rp和rp+n   | 11:transpID:TunnelID:rp               | S请求R，如果R没有收到包，无法穿隧                            |
| 12   |      | S:19986   | R:rp2        | 12:transpID:TunnelID:rp               | S回复R，R得到对应端口                                        |
| 13   |      | R:19986   | S:sp2        | 13:transpID:TunnelID:sp               | R回复S，S得到对应端口                                        |



| 序号 | 发送端低于IP限制锥形                                         | 接收端低于IP限制端 |
| ---- | ------------------------------------------------------------ | ------------------ |
| 1    | S、R使用19986端口、携带传输id请求SV的19986端口后监听，SV记录双方网关地址 |                    |
| 2    | SV返回穿隧id和双方地址                                       |                    |
| 3    | S使用19989端口向R的网关的任意端口发送任意数据包(此时S的网关将接收来自R网关IP的任意数据包) |                    |
| 4    | S使用19986端口、携带穿隧id和序号请求SV19986端口              |                    |
| 5    | SV收到S的请求后，要求R回复S                                  |                    |
| 6    | R使用19986端口回复S(端口为SV获取到的)、及附近的端口，包中携带raddr的端口 |                    |
| 7    | 由于S只监听本地19986端口，所以只会收到一个R的回复包，或者收不到；如果收到，则回复此包。若没有收到，则等待2s；2s后还未收到R的回复、则传输失败 |                    |
| 8    | 如果R在进行操作6之后1s内没有收到S的回复，则可以猜测端口或判定穿隧失败 |                    |



通过上面的表单我们可以发现，能穿隧的情况可以分为两种：receiver是对称形和receiver不是对称形。在程序实现中，为了简单我们也是这样做的，其中receiver不是对称形情况中我们选择`端口限制锥形-端口限制锥形 `即可兼容所有无对称形情况。

于是，我们有：

| class              | directions                                                   |
| ------------------ | ------------------------------------------------------------ |
| receiver是对称形   | S和R请求SV，SV得到两者网关的IP、S的Port，SV控制：R---->S(IP~s~ :Ports~s~)空包，SV立即控制：S---->R(IP~r~ :Ports~r'all~)flag包，R回复SV获取到的Port~r~，SV立即控制: S---->R(IP~r~ :Ports~r~)数据包 |
| receiver不是对称形 | S和R请求SV，SV得到两者网关的IP:Port，SV控制: R---->S(IP~s~ :Ports~s~)空包，SV立即控制: S---->R(IP~r~ :Ports~r~)数据包 |

