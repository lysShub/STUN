

# STUN

​		UDP穿隧；实现了[rfc3489](https://tools.ietf.org/html/rfc3489)的功能，但并没有遵循其协议。

​		本仓库包含两个主要功能：NAT类型判断和NAT穿隧。都需要Sever支持，由于没有遵循标准rfc协议，所以服务器需要自己搭建。

​		功能的实现基于几种NAT其本身的性质。

### NAT类型

```php
网络地址转换（英语：Network Address Translation，缩写：NAT；又称网络掩蔽、IP掩蔽）在计算机网络中是一种在IP数据包通过路由器或防火墙时重写来源IP地址或目的IP地址的技术。这种技术被普遍使用在有多台主机但只通过一个公有IP地址访问互联网的私有网络中。它是一个方便且得到了广泛应用的技术。当然，NAT也让主机之间的通信变得复杂，导致了通信效率的降低。--wikipedia
```

​		严格意义上，NAT网关分为：静态NAT、动态NAT、PAT(端口多路复用)，PAT和NAPT(网络地址端口转换)相似。我们的对象是NAPT，这样的话、如果NAPT能完成穿隧，那么动态NAT和静态NAT也能实现。以下NAPT成为NAT。

​		NAT分类与性质：

| name                              | directions                                                   |
| --------------------------------- | ------------------------------------------------------------ |
| 完全锥形(Full Cone)               | 映射建立后，NAT会接收并转发所有数据包到映射对应的内网机器上  |
| IP限制锥形(Restricted Cone)       | 映射建立后，NAT只会接收并转发来自指定IP的数据包，这个指定IP在映射创建时确定 |
| 端口限制锥形(PortRestricted Cone) | 映射建立后，NAT只会接收并转发来自指定IP且指定端口的数据包，即来自指定地址的数据包 |
| 对称形(Symmetric NAT)             | 对”来“的数据包具有端口限制锥形的规则同时；如果”去“的数据包的四元组发生改变，还将会创建新的映射 |

说明：

- 映射的建立只能是由内网机器请求公网IP时在NAT网关创建。四元组即通信双方的IP和端口。
- IP限制锥形大多时称为限制锥形(Restricted Cone)，称其为IP限制锥形更明了。

### NAT类型判断

​		设计中我们可以不对完全锥形和IP限制锥形进行区分，因为区分需要两个公网IP、不很方便；如果需要区分，建议在一台VPS上绑定2张网卡。

​		client和sever都需要两个端口，称为第一端口和第二端口，下表中选取19987作为第一端口、19988作为第二端口。当前版本需要clietn和sever的第一第二端口相同，下一个版本将进行改进。

说明：

s1,s2是服务器的第一第二使用端口

c1,c2是客户端的第一第二使用端口

| 序号                       | 发送者    | 接收者    | 数据       | 说明                                                         |
| -------------------------- | --------- | --------- | ---------- | ------------------------------------------------------------ |
| 1                          | client:c1 | sever:s1  | Juuid:1:c1 | 开始，sever应保存Juuid、对方网关端口，及使用端口             |
| 2                          | sever:s1  | client:c1 | Juuid:2    | sever回复client，client接受到2后将执行3，没有接收到执行e     |
| 3                          | client:c2 | sever:s1  | Juuid:3:c2 | client使用的第二端口回复sever, sever比较两次(1和3)请求的网关端口是否相等。相等需要进一步判断(是锥形NAT，4)。不相等则有对称形NAT和公网IP两种情况；如果两次请求的网关端口分别和c1、c2相同为公网IP，否则为对称NAT(d)。有一定的误判率。 |
| 4                          | sever:s2  | client:c1 | Juuid:4    | sever使用第二端口进行回复，client不能收到则表示为端口限制形NAT(c)，否则为完全锥形或IP限制锥形NAT(6) |
| 5                          | sever:s1  | client:c1 | Juuid:5    | 表示服务器执行了4                                            |
| <font color='red'>6</font> | client:c1 | sever:s1  | Juuid:6    | 客户端回复表示收到了4，为完全或IP限制锥形NAT，如须进一步区分、执行7,8；否则服务器也回复6 |
| 7                          | sever2:s1 | client:c1 | Juuid:7    | 可选，sever使用第二IP回复client                              |
| 8                          | sever:s1  | client:c1 | Juuid:8    | 可选，表示服务器执行了7，接下来执行a,b                       |
| <font color='red'>9</font> | sever:s1  | client:c1 | Juuid:9    | 公网IP                                                       |
| <font color='red'>a</font> | client:c1 | sever:s1  | Juuid:a    | client收到8且收到7，完全锥形nat                              |
| <font color='red'>b</font> | client:c1 | sever:s1  | Juuid:b    | client收到8且没有收到7，IP限制形nat                          |
| <font color='red'>c</font> | client:c1 | sever:s1  | Juuid:c    | client收到5但没有收到4，端口限制nat                          |
| <font color='red'>d</font> | sever:s1  | client:c1 | Juuid:d    | 对称形nat                                                    |
| <font color='red'>e</font> | client:c1 | sever:s1  | Juuid:e    | 可能服务器关闭                                               |
| <font color='red'>f</font> | client:c1 | sever:s1  | Juuid:e    | 异常情况                                                     |

说明：

- 红色即是可能返回值。
- 由于UDP不可靠，实际程序实现中同一数据包被发送多次。
- 数据中Juuid是16字节的唯一ID，`:`实际不存在，只是为了便于观看；最后字节数据序号(16进制)







### NAT穿透





| 序号 | 发   | 收   | data                | 说明                                                         |
| ---- | ---- | ---- | ------------------- | ------------------------------------------------------------ |
| 1    | S和R | SV   | Tuuid:1:y           | 双方Tuuid要相同，y表示客户端的NAT类型，双方使用的端口称为使用端口 |
| 3    | SV   | S和R | Tuuid:3:?:rIP:rPort | SV回复，?为0或1，0为低的一方。rIP和rPort是对方的网关IP和主端口。IP占用4个字节，端口2个字节 |
| 4    | 低   | 高   | Tuuid:4:sport       | 低的一方的使用端口请求高的一方的使用端口的泛端口，sport是低的一方使用端口；高的一方无需接收次包，即使有可能收到。 |
| 5    | 低   | SV   | Tuuid:5:sport:ep    | 低的一方执行4之后请求SV，再之后监听使用端口。ep为泛端口范围、2个字节。 |
| 6    | SV   | 高   | Tuuid:6:sport:ep    | SV通知高的一方，lport是低的一方使用端口，之后7               |
| 7    | 高   | 低   | Tuuid:7             | 高的一方的使用端口将请求低的一方的使用端口泛端口；发送完将监听使用端口。如果低的一方能收到此数据包穿则隧成功，高的一方将收到回复8；否则超时之后判断无法穿透。(低的一方接收到此包后能得到高的一方的网关地址) |
| 8    | 低   | 高   | Tuuid:8             | 收到7之后的回复(高的一方收到此包后可以知道低的一方的网关地址) |

说明：

- 端口说明: 
  - 使用端口：及所在机器本身使用的端口，只不过经过NAT网关后大部分情况下会被更改。
  - 某端口的泛端口是指此端口及其相连的几个端口、如端口100的泛端口可以是：[100、101、102、103]，此时p为4。
- 文中`高的一方`和`低的一方`是指NAT限制的高低，如果双方是IP限制锥形和端口限制锥形，则端口限制锥形是高的一方
- NAT类型(步骤1中的y)与NAT类型判断的返回结果相对应，及9-d；如果返回6则需转换为b(IP限制锥形)









| 序号 | 发   | 收   | data                 | 说明                                                         |
| ---- | ---- | ---- | -------------------- | ------------------------------------------------------------ |
| 1    | S和R | SV   | Tuuid:1:y:ep         | 双方Tuuid要相同，y表示客户端的NAT类型，占用一个字节。ep为泛端口长度，如果双方不同取其长，占用2个字节 |
| 2    | SV   | S和R | Tuuid:2:rIP:rPort:ep | SV回复双方，?为0或1，0为低的一方。rIP和rPort是对方的网关IP和主端口。IP占用4个字节，端口2个字节。 |
| 4    | 低   | 高   | Tuuid:4:sport        | 低的一方的使用端口请求高的一方的使用端口的泛端口，sport是低的一方使用端口；高的一方无需接收次包，即使有可能收到。 |
| 7    | 高   | 低   | Tuuid:7              | 高的一方的使用端口将请求低的一方的使用端口泛端口；发送完将监听使用端口。如果低的一方能收到此数据包穿则隧成功，高的一方将收到回复8；否则超时之后判断无法穿透。(低的一方接收到此包后能得到高的一方的网关地址) |
| 8    | 低   | 高   | Tuuid:8              | 收到7之后的回复(高的一方收到此包后可以知道低的一方的网关地址) |

